#!/bin/sh

dir=.vee

sort_new_first='sort -t. -nr'
sort_old_first='sort -t. -n'
sort="$sort_new_first"
stripext=0
usels=0
lsopts='-lat'

 die_error()
{ 
  echo $1
  exit 1
}

 die_cleanly()
{ 
  exit 0
}

 usage() 
{
	man veels
}

while getopts 'd:hlL:rx' option; do
    case $option in
    d) if [ -d "$optarg" ]; then
         cd "$optarg"
       else
         echo "$optarg" is not a directory!
         die_cleanly
       fi
       ;;
    l) usels=1 #use ls with default opts
       ;;
    l) usels=1 #use ls with custom opts
       lsopts="$optarg"
       ;;
    r) sort=$sort_old_first  # list in reverse post order
       ;;
    x) stripext=1 #strip .raw from output
       ;;
    h) usage # some help page
       die_cleanly
       ;;
    esac
done

 read_config()
{ if [ -e ./.veerc ]; then
    . ./.veerc
  fi
} 

 get_sorted()
{
    ls -1 "$dir"/*.raw | $sort
}

 get_title()
{
	title=$(head -n 3 "$1" | tail -n 1)
    echo "$title"
}

 get_date()
{
	date=$(head -n 1 "$1")
    echo "$date"
}

 _ls ()
{
   ls "$lsopts" "$1"
}

#-- main program body

#-- read config, $(pwd)/.veerc (happens after "-d" so it's consistent
#--      with how bin/vee does it)
read_config   

for f in $(get_sorted); 
do
    # title is the 3rd line
	TITLE=$(get_title "$f")

    # full date string (not epoch) is the first line
	DATE=$(get_date "$f")

    if [ 1 -eq $usels ]; then
        _ls "$f"
    else
	    if [ 1 -eq $stripext ]; then
                echo "${f%\.*}"
	    else 
		echo "$f"
	    fi
    fi
done
