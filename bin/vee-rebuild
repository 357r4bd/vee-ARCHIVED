#!/bin/sh

gendate=$(date)
veedir=./.vee
htmlext=html

 die_error()
{ 
  echo "$1"
  exit 1
}

 die_cleanly()
{ 
  exit 0
}

 usage() 
{
	man vee-rebuild
}

while getopts 'd:h' option; do
    case $option in
    d) if [ -d "$optarg" ]; then
         cd "$optarg"
       else
         echo "$optarg" is not a directory!
         die_cleanly
       fi
       ;;
    h) usage # some help page
       die_cleanly
       ;;
    esac
done

if [ ! -d "$veedir" ]; then
    echo "Can't find $veedir!"
    exit;
fi

echo "<!-- ;1000000000000000000000000; initial HTML -->"
echo "<!-- ;100000000000000000000000; more HTML -->"
echo "<!-- ;10000000000000000000000; new index regenerated on $gendate -->"
echo "<!-- ;1000000000000000000000; pre tag --><pre>"

for f in "$(veels)"; 
do
    # title is the 3rd line
	title=$(echo "$f" | veecat -t)

    # full date string (not epoch) is the first line
	date=$(echo "$f" | veecat -d)

    # deal with with timezone info in a brutish way (seems like a TZ mismatch in data input will cause error)
	tz_sys=$(date "+%Z")
	dow=$(echo "$date" | awk '{ print "$1" }')
	mon=$(echo "$date" | awk '{ print "$2" }')
	dom=$(echo "$date" | awk '{ print "$3" }')
	hms=$(echo "$date" | awk '{ print "$4" }')
	tzn=$(echo "$date" | awk '{ print "$5" }')
	yr=$(echo "$date" | awk '{ print "$6" }')

    # reformate date for indexing purposes (.raw files untouched)
	formatted_date=$(date -d"$date" +%m/%d/%y)

    # get epoch for purpose of adding reasonable post index numbers 
	epoch=$(date -d"$date" "+%s") 

    # extract base name of .raw file so we can link to html file of same base
    filename=$(basename "$f")
    basename=${filename%.*}
    # output HTML index (can be modified to output in whatever format)
    echo "<!-- ;$epoch; -->$formatted_date <a href=$veedir/$basename.$htmlext>$title</a>"
done

echo "<!-- ;2; closing -->"
echo '<!-- ;1; closing -->Powered by <a href="http://www.0x743.com/vee">vee</a>'
echo "<!-- ;0; closing pre tag --></pre>"
